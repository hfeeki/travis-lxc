#!/bin/bash

usage() {
  echo "Usage: `basename $0 .sh` [-b build_timeout] [-l log_timeout] command"
  exit 1
}

args=`getopt l:b: $*`
[ $? != 0 ] && usage
set -- $args

build_timeout=1800
log_timeout=300

for i; do
  case $i in
    -l) log_timeout=$2;   shift; shift;;
    -b) build_timeout=$2; shift; shift;;
    --) shift; break;;
  esac
done

terminate() {
  echo; echo $2
  pkill -P $1
  exit 1
}

out=$(mktemp /tmp/build.log.XXXX)
trap "rm -f $out" EXIT
exec > >(tee -a $out)

eval $@ <&0 &
pid=$!

start=$(date +%s)
while ps aux | awk '{print $2 }' | grep -q $pid 2> /dev/null; do
  now=$(date +%s)
  log=$(stat -f %m $out)
  [ $(expr $now - $start) -ge $build_timeout ] && terminate $pid "Timed out after $build_timeout seconds."
  [ $(expr $now - $log)   -gt $log_timeout   ] && terminate $pid "No log output for $log_timeout seconds."
  sleep 1
done

